# 超级玛丽录制系统使用说明

## 功能概述

本系统为超级玛丽游戏添加了录制功能，可以记录游戏过程中的每一帧图片和对应的玩家动作。

## 使用方法

### 1. 正常游戏模式（非录制）
```bash
python mario_level_1.py
```

### 2. 录制模式, 默认skip 1, quality high
```bash
python mario_level_1.py --record
# 或者
python mario_level_1.py -r
```

### 3. 优化录制模式，减少卡顿（若有卡顿）
```bash
# 每2帧保存一次，中等质量
python mario_level_1.py --record --skip 2 --quality medium

# 每3帧保存一次，低质量（最流畅）
python mario_level_1.py --record --skip 3 --quality low

# 每帧都保存，高质量（最完整但可能卡顿）
python mario_level_1.py --record --skip 1 --quality high
```

### 录制参数说明
- `--record` 或 `-r`: 开启录制模式
- `--skip N`: 帧跳过间隔，每N帧保存一次图片（默认1）
- `--quality [low|medium|high]`: 图片质量（默认medium）

## 动作编码

### 基础动作编码
| 动作 | 键位 | 编码值 |
|------|------|--------|
| 向左移动 | 左箭头 | 1 |
| 向右移动 | 右箭头 | 2 |
| 跳跃 | A键 | 4 |
| 动作/加速/火球 | S键 | 8 |
| 蹲下 | 下箭头 | 16 |

### 编码规则
- 每一帧的动作 = 所有按下键的**位或运算**（OR运算）
- 左右键互斥：同时按下时只有左键生效
- 其他键可组合：跳跃、动作键、蹲下可以与移动方向组合

### 组合动作示例
- `无动作` = 0
- `左移` = 1
- `右移` = 2
- `左移+右移` = 1+2 = 3 (但游戏中左右互斥，实际不会出现)
- `跳跃` = 4
- `左跳` = 1 + 4 = 5
- `右跳` = 2 + 4 = 6
- `左移+右移+跳跃` = 1+2+4 = 7 (但游戏中左右互斥，实际不会出现)
- `动作/加速/火球` = 8
- `左移+动作` = 1 + 8 = 9
- `右移+动作` = 2 + 8 = 10
- `左移+右移+动作` = 1+2+8 = 11 (但游戏中左右互斥，实际不会出现)
- `跳跃+动作` = 4 + 8 = 12
- `左跳+动作` = 1 + 4 + 8 = 13
- `右跳+动作` = 2 + 4 + 8 = 14
- `左移+右移+跳跃+动作` = 1+2+4+8 = 15 (但游戏中左右互斥，实际不会出现)
- `蹲下` = 16
- `左移+蹲下` = 1 + 16 = 17
- `右移+蹲下` = 2 + 16 = 18
- `左移+右移+蹲下` = 1+2+16 = 19 (但游戏中左右互斥，实际不会出现)
- `跳跃+蹲下` = 4 + 16 = 20
- `左跳+蹲下` = 1 + 4 + 16 = 21
- `右跳+蹲下` = 2 + 4 + 16 = 22
- `左移+右移+跳跃+蹲下` = 1+2+4+16 = 23 (但游戏中左右互斥，实际不会出现)
- `动作+蹲下` = 8 + 16 = 24
- `左移+动作+蹲下` = 1 + 8 + 16 = 25
- `右移+动作+蹲下` = 2 + 8 + 16 = 26
- `左移+右移+动作+蹲下` = 1+2+8+16 = 27 (但游戏中左右互斥，实际不会出现)
- `跳跃+动作+蹲下` = 4 + 8 + 16 = 28
- `左跳+动作+蹲下` = 1 + 4 + 8 + 16 = 29
- `右跳+动作+蹲下` = 2 + 4 + 8 + 16 = 30
- `左移+右移+跳跃+动作+蹲下` = 1+2+4+8+16 = 31 (但游戏中左右互斥，实际不会出现)

### 实际游戏中会出现的动作编码 (0-30)
| 编码 | 动作组合                 | 描述 |
|------|----------------------|------|
| 0 | 无动作                  | 静止 |
| 1 | LEFT                 | 向左移动 |
| 2 | RIGHT                | 向右移动 |
| 4 | A                    | 原地跳跃 |
| 5 | LEFT + A             | 向左跳跃 |
| 6 | RIGHT + A            | 向右跳跃 |
| 8 | S                    | 原地动作/加速/火球 |
| 9 | LEFT + S             | 向左加速跑 |
| 10 | RIGHT + S            | 向右加速跑 |
| 12 | A + S                | 原地跳跃+动作 |
| 13 | LEFT + A + S         | 向左加速跳跃 |
| 14 | RIGHT + A + S        | 向右加速跳跃 |
| 16 | DOWN                 | 蹲下 |
| 17 | LEFT + DOWN          | 向左蹲下移动 |
| 18 | RIGHT + DOWN         | 向右蹲下移动 |
| 20 | A + DOWN             | 蹲下跳跃 |
| 21 | LEFT + A + DOWN      | 向左蹲下跳跃 |
| 22 | RIGHT + A + DOWN     | 向右蹲下跳跃 |
| 24 | S + DOWN             | 蹲下+动作 |
| 25 | LEFT + S + DOWN      | 向左蹲下+动作 |
| 26 | RIGHT + S + DOWN     | 向右蹲下+动作 |
| 28 | JUMP + S + DOWN      | 蹲下跳跃+动作 |
| 29 | LEFT + A + S + DOWN  | 向左蹲下加速跳跃 |
| 30 | RIGHT + A + S + DOWN | 向右蹲下加速跳跃 |

## 录制数据格式

### 目录结构
```
recordings/
└── recording_[timestamp]/
    ├── frames/                    # 帧图片目录
    │   ├── frame_000000.png
    │   ├── frame_000001.png
    │   └── ...
    └── recording_data.json        # 主要录制数据
```

### recording_data.json 格式
```json
{
  "recording_info": {
    "total_frames": 1500,
    "duration": 50.0,
    "recording_time": "2024-01-01 12:00:00",
    "game_version": "Mario Level 1"
  },
  "frame_data": [
    {
      "frame_id": 0,
      "timestamp": 0.0,
      "action_code": 6,
      "action_binary": "0b110",
      "action_names": ["RIGHT", "JUMP"],
      "mario_state": "jump",
      "mario_dead": false,
      "frame_filename": "frame_000000.png"
    }
  ]
}
```

### statistics.json 格式
```json
{
  "action_statistics": {
    "0": 200,    // 静止帧数
    "1": 150,    // 左移帧数
    "2": 180,    // 右移帧数
    "6": 100     // 右跳帧数
  },
  "state_statistics": {
    "walk": 800,
    "jump": 300,
    "stand": 200
  }
}
```

## 录制系统特性

1. **自动帧捕获**：每帧自动保存屏幕截图
2. **动作编码**：使用位掩码高效编码多键组合
3. **状态记录**：记录马里奥的当前状态和死亡状态
4. **时间戳**：每帧都有精确的时间戳
5. **统计信息**：自动生成动作和状态统计
6. **安全退出**：支持Ctrl+C安全停止录制
7. **性能优化**：支持帧跳过和图片质量调整，减少卡顿

## 性能优化选项

### 帧跳过 (--skip)
- `--skip 1`: 每帧都保存（最完整，可能卡顿）
- `--skip 2`: 每2帧保存一次（平衡性能和完整性）
- `--skip 3`: 每3帧保存一次（更流畅，适合低配置）
- `--skip 5`: 每5帧保存一次（最流畅，但可能丢失细节）

### 图片质量 (--quality)
- `low`: 图片缩小到50%，文件小，保存快
- `medium`: 图片缩小到75%，平衡质量和性能（推荐）
- `high`: 保持原尺寸，文件大，保存慢

### 性能建议
- **低配置电脑**: `--skip 3 --quality low`
- **中等配置**: `--skip 2 --quality medium`
- **高配置电脑**: `--skip 1 --quality high`

## 注意事项

1. 录制会占用大量磁盘空间，建议定期清理
2. 录制模式可能会略微影响游戏性能
3. 左右移动键互斥，不会同时生效
4. 录制数据保存在 `recordings/` 目录下

## 开发说明

### 核心文件
- `data/recorder.py` - 录制器类
- `data/tools.py` - 修改Control类支持录制
- `data/states/level1.py` - 添加马里奥状态获取方法
- `mario_level_1.py` - 主入口文件，支持命令行参数

### 扩展功能
可以通过修改 `Recorder` 类来添加更多录制功能，如：
- 录制音效
- 录制游戏分数
- 录制敌人状态
- 自定义数据格式
